## 測試
下載pre-build [image](https://www.96boards.org/documentation/consumer/ultra96/ultra96-v2/downloads/linux.md.html)

## 事前準備
1. 安裝docker ubuntu22.04
```
docker build \
  --build-arg USER_UID=$(id -u) \
  --build-arg USER_GID=$(id -g) \
  -t my-petalinux:20.04 .
```

```
docker run -it \
  --name petalinux_lab \
  -v /home/itri2004/workspace/petalinux_docker:/home/pluser/workspace \
  -w /home/pluser/workspace \
  my-petalinux:20.04
```
2. petalinux 2024.2
3. 下載sstate ＆ download (amd download embedded software) [link](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/embedded-design-tools.html)
![download](./pic/sstate.png)
4. 下載bsp [link](https://www.avnet.com/americas/products/avnet-boards/avnet-board-families/ultra96-v2/)
### 在docker中安裝petalinux
```
chmod +x petalinux-v2024.2-final-installer.run
./petalinux-v20xx.xx-final-installer.run --dir ./tools

source /home/pluser/petalinux/settings.sh
```
### 進出docker
```
docker ps -a

docker start <container_name>

docker exec -it <container_name> bash

source /home/pluser/petalinux/settings.sh
```

### build project

petalinux-create -t project -s <bsp_file> -n test_project

### petalinux-config
petalinux-config --get-hw-description <.xsa path>
- xsa在project hardware中
### config 離線包路徑
- aarch64
→ Yocto Settings → Local sstate feeds settings
`/home/pluser/workspace/offline/aarch64`
- downloads
→ Yocto Settings → Add pre-mirror url
`/home/pluser/workspace/offline/dowloads`
- u-boot
→ Linux Components Selection → u-boot → ext-local-src [*]
→ Linux Components Selection → External u-boot local source settings

- Linux-kernel-Src
→ Linux Components Selection → linux-kernel → ext-local-src[*]
→ Linux Components Selection → External linux-kernel local source settings

## 安裝套件
在`project-spec/meta-user/conf/user-rootfsconfig`中加入
CONFIG_packagegroup-petalinux-qt
CONFIG_packagegroup-petalinux-x11
### 純xsa燒錄 uart setting
在`project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi`中加入
```
/include/ "system-conf.dtsi"

/ {
    /* 1. 定義別名：告訴系統 serial0 其實是對應到硬體的 uart1 */
    aliases {
        serial0 = &uart1;
    };

    /* 2. 指定 Console 輸出位置 */
    chosen {
        /* bootargs: 告訴 Kernel 開機參數，將 console 指向 ttyPS0 (因為上面做了 alias，uart1 變成了 serial0) */
        bootargs = "earlycon console=ttyPS0,115200 clk_ignore_unused root=/dev/mmcblk0p2 rw rootwait";
        
        /* stdout-path: 告訴 U-Boot 和 Kernel 預設輸出是 serial0 */
        stdout-path = "serial0:115200n8";
    };
};

/* 3. 確保 uart1 被啟用 */
&uart1 {
    status = "okay";
    u-boot,dm-pre-reloc; /* 讓 U-Boot 在早期階段就能用它 */
};
```

### 開始build
petalinux-build 2>&1 | tee build.log
petalinux-package --boot --fsbl images/linux/zynqmp_fsbl.elf --u-boot images/linux/u-boot.elf --pmufw images/linux/pmufw.elf --fpga images/linux/system.bit --force


## 燒錄
取消掛載
sudo umount /dev/sda1
sudo umount /dev/sda2
格式化
sudo mkfs.vfat -F 32 -n BOOT /dev/sda1
建立掛載點
sudo mkdir -p /mnt/sd_boot
sudo mount /dev/sda1 /mnt/sd_boot
複製image
cd ~/work/test_project/images/linux/
sudo cp BOOT.BIN boot.scr image.ub /mnt/sd_boot/
檢查並卸載
ls /mnt/sd_boot/  # 確認有看到三個檔案
sudo umount /mnt/sd_boot
燒錄
sudo umount /dev/sda2
sudo dd if=rootfs.ext4 of=/dev/sda2 bs=4M status=progress
sync

## 清除build

petalinux-build -x mrproper
rm -rf build/
rm -rf components/

petalinux-config




## xsct
source /tools/Xilinx/Vitis/2023.2/settings64.sh

xsct

connect

targets

## 理解
bsp -> 幫你功能開好 沒有bsp照樣能開只是功能需要自己加 (官方bsp有誤 燒不進去)

xsa -> vivado產生 利用petalinux-config設定 並build 純xsa是沒有任何功能需要開啟kernel設定

ps->Linux端

pl->FPGA